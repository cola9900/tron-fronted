<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>钱包绑定</title>
</head>
<body>
  <h2>TronWeb 钱包绑定</h2>
  <button id="bindBtn">绑定钱包</button>
  <p id="status"></p>

  <script>
    let userWallet = null;

    // 页面加载时，检测 TronLink 或 TokenPocket 是否注入 tronWeb
    window.addEventListener('load', async () => {
      console.log("页面加载完成，开始检测 TronWeb...");
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        document.getElementById('status').innerText = "未检测到 TronWeb，请在 TokenPocket 或 TronLink 中打开";
        return;
      }

      // 获取当前钱包地址
      userWallet = window.tronWeb.defaultAddress.base58;
      document.getElementById('status').innerText = "检测到钱包地址：" + userWallet;
      console.log("检测到钱包地址：", userWallet);
    });

    // 点击按钮绑定钱包
    document.getElementById('bindBtn').addEventListener('click', async () => {
      if (!userWallet) {
        alert("未检测到钱包地址，请确认已登录钱包");
        return;
      }

      try {
        console.log("开始向后端发送请求，钱包地址：", userWallet);

        const response = await fetch('http://192.168.0.184:3000/bind-wallet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            walletAddress: userWallet,
            session_id: '123456' // 可以替换为实际的邀请参数
          })
        });

        const result = await response.json();
        console.log("后端返回：", result);

        if (result.success) {
          alert("绑定成功！");
        } else {
          alert("绑定失败：" + (result.message || '未知错误'));
        }
      } catch (err) {
        console.error("网络错误：", err);
        alert("网络错误：" + err.message);
      }
    });
  </script>
</body>
</html>
