<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>钱包绑定</title>
</head>
<body>
  <h2>钱包绑定</h2>
  <button id="bindBtn">绑定钱包</button>
  <p id="status"></p>

  <script>
    let userWallet = null;

    // 页面加载时检测 TronWeb
    window.addEventListener('load', () => {
      if (!window.tronWeb) {
        document.getElementById('status').innerText = "未检测到 TronWeb，请在 TokenPocket 或 TronLink 的 DApp 浏览器中打开";
        return;
      }

      // 获取当前钱包地址
      userWallet = window.tronWeb.defaultAddress.base58;
      if (!userWallet) {
        document.getElementById('status').innerText = "请先在钱包中登录账号";
      } else {
        document.getElementById('status').innerText = "检测到钱包地址：" + userWallet;
      }
    });

    // 点击按钮绑定
    document.getElementById('bindBtn').addEventListener('click', async () => {
      if (!userWallet) {
        alert("未检测到钱包地址，请确认已登录钱包");
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/bind-wallet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            address: userWallet, // 和后端字段对应
            session_id: '123456' // 也可以替换为实际邀请链接的参数
          })
        });

        const result = await response.json();

        if (response.ok) {
          alert("绑定成功！地址：" + result.address);
        } else {
          alert("绑定失败：" + result.error);
        }
      } catch (err) {
        alert("网络错误：" + err.message);
      }
    });
  </script>
</body>
</html>
